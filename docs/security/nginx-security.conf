# SystemCraft Security Configuration for Nginx
# This file should be included in your Nginx server configuration
# Example: include /path/to/SystemCraft/docs/security/nginx-security.conf;

# Content Security Policy - Strict policy for maximum security
# This CSP is designed for the SystemCraft platform with its specific requirements
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' 
        https://cdn.jsdelivr.net 
        https://unpkg.com 
        'unsafe-inline' 
        'unsafe-eval' 
        blob:
        data:;
    style-src 'self' 
        https://fonts.googleapis.com 
        https://cdn.jsdelivr.net 
        'unsafe-inline';
    font-src 'self' 
        https://fonts.gstatic.com 
        data:;
    img-src 'self' 
        data: 
        https: 
        blob:;
    media-src 'self' 
        blob: 
        data:;
    connect-src 'self' 
        https://api.github.com 
        wss: 
        ws:;
    frame-src 'none';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests;
    block-all-mixed-content;
    report-uri /security/csp-report;
" always;

# Additional Security Headers
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Strict Transport Security (HSTS) - Enable for HTTPS sites
# Uncomment the following line if serving over HTTPS
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Feature Policy / Permissions Policy
add_header Permissions-Policy "
    camera=(self),
    microphone=(self),
    geolocation=(),
    payment=(),
    usb=(),
    magnetometer=(),
    gyroscope=(),
    accelerometer=(),
    ambient-light-sensor=(),
    autoplay=(self),
    encrypted-media=(self),
    fullscreen=(self),
    picture-in-picture=(self)
" always;

# CSP Reporting Endpoint
location /security/csp-report {
    # Log CSP violations for monitoring
    access_log /var/log/nginx/csp-violations.log;
    
    # Return 204 No Content for CSP reports
    return 204;
    
    # Optional: Forward to security monitoring service
    # proxy_pass http://your-security-monitoring-service/csp-report;
}

# Security-related locations
location ~* \.(js|css)$ {
    # Cache control for security resources
    add_header Cache-Control "public, max-age=31536000, immutable";
    
    # Add security headers to static resources too
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
}

# Disable server signature
server_tokens off;

# Rate limiting for security endpoints
limit_req_zone $binary_remote_addr zone=security_limit:10m rate=10r/m;

location /javascripts/security-utils.js {
    limit_req zone=security_limit burst=5;
    
    # Ensure security utils are served with correct headers
    add_header Cache-Control "public, max-age=86400";
    add_header X-Content-Type-Options "nosniff" always;
}

# Additional rate limiting for API-like endpoints
location ~* ^/(api|auth|login|register) {
    limit_req zone=security_limit burst=20;
}