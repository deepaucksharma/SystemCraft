# SystemCraft Security Configuration for Apache
# This file should be included in your Apache virtual host configuration
# Example: Include /path/to/SystemCraft/docs/security/apache-security.conf

# Enable required modules (add to main Apache config if not already enabled)
# LoadModule headers_module modules/mod_headers.so
# LoadModule rewrite_module modules/mod_rewrite.so
# LoadModule evasive_module modules/mod_evasive24.so

# Content Security Policy - Strict policy for maximum security
Header always set Content-Security-Policy "\
    default-src 'self'; \
    script-src 'self' https://cdn.jsdelivr.net https://unpkg.com 'unsafe-inline' 'unsafe-eval' blob: data:; \
    style-src 'self' https://fonts.googleapis.com https://cdn.jsdelivr.net 'unsafe-inline'; \
    font-src 'self' https://fonts.gstatic.com data:; \
    img-src 'self' data: https: blob:; \
    media-src 'self' blob: data:; \
    connect-src 'self' https://api.github.com wss: ws:; \
    frame-src 'none'; \
    object-src 'none'; \
    base-uri 'self'; \
    form-action 'self'; \
    frame-ancestors 'none'; \
    upgrade-insecure-requests; \
    block-all-mixed-content; \
    report-uri /security/csp-report;"

# Additional Security Headers
Header always set X-Frame-Options "DENY"
Header always set X-Content-Type-Options "nosniff"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"

# Strict Transport Security (HSTS) - Enable for HTTPS sites
# Uncomment the following line if serving over HTTPS
# Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# Feature Policy / Permissions Policy
Header always set Permissions-Policy "\
    camera=(self), \
    microphone=(self), \
    geolocation=(), \
    payment=(), \
    usb=(), \
    magnetometer=(), \
    gyroscope=(), \
    accelerometer=(), \
    ambient-light-sensor=(), \
    autoplay=(self), \
    encrypted-media=(self), \
    fullscreen=(self), \
    picture-in-picture=(self)"

# Remove server signature
ServerTokens Prod
ServerSignature Off

# CSP Reporting Endpoint
<Location "/security/csp-report">
    # Log CSP violations
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" CSP_VIOLATION" csp_log
    CustomLog /var/log/apache2/csp-violations.log csp_log
    
    # Return 204 No Content for CSP reports
    RewriteEngine On
    RewriteRule ^.*$ - [R=204,L]
    
    # Optional: Forward to security monitoring service
    # ProxyPass http://your-security-monitoring-service/csp-report
</Location>

# Security for static resources
<LocationMatch "\.(js|css)$">
    # Cache control for security resources
    Header set Cache-Control "public, max-age=31536000, immutable"
    
    # Add security headers to static resources
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
</LocationMatch>

# Rate limiting using mod_evasive (if available)
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        10
    DOSSiteCount        100
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
    
    # Whitelist localhost
    DOSWhitelist        127.0.0.1
    
    # Log directory
    DOSLogDir           /var/log/apache2/evasive
    
    # Email notification (optional)
    # DOSEmailNotify      security@yourdomain.com
</IfModule>

# Additional security for sensitive files
<Files "security-utils.js">
    # Ensure security utils are served with correct headers
    Header set Cache-Control "public, max-age=86400"
    Header always set X-Content-Type-Options "nosniff"
</Files>

# Block access to sensitive files and directories
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<DirectoryMatch "^.*/(\.git|\.svn|CVS)">
    Require all denied
</DirectoryMatch>

# Security for API-like endpoints (if any)
<LocationMatch "^/(api|auth|login|register)">
    # Add additional rate limiting here if mod_evasive is not sufficient
    # Consider using mod_security or fail2ban for advanced protection
</LocationMatch>

# Prevent access to backup files and logs
<FilesMatch "\.(bak|backup|log|old|orig|save|swo|swp|tmp)$">
    Require all denied
</FilesMatch>

# Enable MIME type checking
<IfModule mod_mime.c>
    # Force correct MIME types for security
    AddType application/javascript .js
    AddType text/css .css
    AddType application/json .json
</IfModule>